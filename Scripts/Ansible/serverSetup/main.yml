---
- hosts: server
  vars:
    defaultUserName: aelchert
    defaultAdminGroup: admin

  tasks:
    # - name: Update cache
    #   apt:
    #     update_cache: yes



    - name: add group
      group:
        name: admin
        state: present

    - name: user/group
      user:
        name: "{{ defaultUserName }}"
        comment: "Adam Elchert"
        groups: admin
        shell: /bin/bash
        state: present

    - name: Add admin group to Sudoers
      lineinfile:
          dest: /etc/sudoers
          state: present
          regexp: "{{ item.name }}"
          line: "{{ item.line }}"
      with_items:
        - { name: '^admin', line: 'admin ALL=(ALL:ALL) ALL' }
        - { name: '^aelchert', line: 'aelchert ALL=(ALL:ALL) ALL' }

    - name: copy keys to aelchert
      authorized_key:
        user: aelchert
        key: "{{ item }}"
      with_file:
        - templates/keys.keys

    - name: copy keys to root
      authorized_key:
        user: root
        key: "{{ item }}"
      with_file:
        - templates/keys.keys


      #
      #
      # # - name: copy basic bashrc to defaultUserName root folder
      # #   copy:
      # #     src: /Users/adamschoonover/Git/Personal/Server/AnsiblePlaybooks/roles/common/templates/bashrc
      # #     dest: /home/aelchert/.bashrc
      # #     mode: 0644
      #
      #
      # - name: Create ssh key directory
      #   action:
      #     file path: "/home/{{ defaultUserName }}/.ssh/"
      #
      # - name: copy pub key to remote machine
      #   authorized_key:
      #     user: "{{ defaultUserName }}"
      #     key: "{{ lookup('file', lookup('env','HOME') + '/.ssh/id_rsa.pub') }}"
      #
      #
      # - name: copy ssh key from host to server
      #   authorized_key:
      #     user: adamschoonover
      #     key: "{{ lookup('file', '/home/adamschoonover/.ssh/id_rsa.pub')}}"
      #
      # - name: Set up authorized keys for new user
      #   authorized_key:
      #     user: aelchert
      #     key: "{{ item }}"
      #   with_file:
      #     - /home/adamschoonover/id_rsa.pub
      #
      # # - name: Change ssh port
      # #   lineinfile:
      # #     dest: /etc/ssh/sshd_config
      # #     regexp: '^Port\s'
      # #     line: "Port {{ ssh_port }}"
      # #     state: present
      # #   notify: restart ssh
      #
      # - name: Disable root login
      #   lineinfile:
      #     dest: /etc/ssh/sshd_config
      #     regexp: '^PermitRootLogin'
      #     line: "PermitRootLogin no"
      #     state: present
      #   notify: restart ssh
      #
      # # - name: Disable password authentication
      # #   lineinfile:
      # #     dest: /etc/ssh/sshd_config
      # #     regexp: '^PasswordAuthentication'
      # #     line: "PasswordAuthentication no"
      # #     state: present
      # #   notify: restart ssh
      #
      # # - name: Only allow SSH access for the newly created user
      # #   lineinfile:
      # #     dest: /etc/ssh/sshd_config
      # #     insertafter: '^StrictModes'
      # #     line: "AllowUsers {{ user }}"
      # #     state: present
      # #   notify: restart ssh
      #
      # ######
      #
      # - name: Update all packages
      #   apt:
      #     update_cache: yes
      #     upgrade: safe
      #     autoremove: yes
      #
      # - name: Install essential packages
      #   apt:
      #     name: "{{ item }}"
      #     update_cache: yes
      #     cache_valid_time: 3600
      #     state: latest
      #   with_items:
      #     - htop
      #     - git
      #     - ntp
      #     - python3
      #     - python
